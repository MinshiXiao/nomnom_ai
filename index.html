<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>NomNom ç¾é£Ÿåœ°åœ–</title>
    <style>
        /* è®“åœ°åœ–å¡«æ»¿è¢å¹• */
        html, body { height: 100%; margin: 0; padding: 0; }
        #map { height: 100%; width: 100%; }
        .loading { 
            position: absolute; top: 50%; left: 50%; 
            transform: translate(-50%, -50%); 
            font-family: sans-serif; color: #666;
        }
    </style>
</head>
<body>
    <div id="map"></div>
    <div id="loading" class="loading">è®€å–ç¾é£Ÿè³‡æ–™ä¸­...</div>

    <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>

    <script>
        const XANO_API_URL = "https://x8ki-letl-twmt.n7.xano.io/api:ygZLF4dX/user/map_restaurants"; // å¡«å…¥ Xano API

        async function main() {
            // 1. åˆå§‹åŒ– LIFF
            await liff.init({ liffId: "2008587350-Nba5PAbR" }); // å¡«å…¥ LIFF ID

            if (!liff.isLoggedIn()) {
                liff.login();
                return;
            }

            const profile = await liff.getProfile();
            const userId = profile.userId;

            // 2. å‘¼å« Xano æ‹¿è³‡æ–™
            try {
                const response = await fetch(`${XANO_API_URL}?line_user_id=${userId}`);
                const restaurants = await response.json();
                
                document.getElementById('loading').style.display = 'none';
                initMap(restaurants);
            } catch (error) {
                alert("è®€å–è³‡æ–™å¤±æ•—ï¼š" + error.message);
            }
        }

        function initMap(data) {
            // 1. è™•ç†è³‡æ–™çµæ§‹
            const restaurants = Array.isArray(data) ? data : (data.restaurants || []);

            console.log("æ”¶åˆ°çš„é¤å»³æ•¸é‡:", restaurants.length);

            // 2. é è¨­ä¸­å¿ƒé» (å°åŒ—)
            const center = { lat: 25.0478, lng: 121.5170 };
            
            // å¦‚æœç¬¬ä¸€ç­†è³‡æ–™æœ‰åº§æ¨™ï¼Œå°±ä»¥å®ƒç‚ºä¸­å¿ƒ
            // [ä¿®æ­£é»] æ”¹ç”¨ .location
            if (restaurants.length > 0 && restaurants[0].location && restaurants[0].location.data) {
                center.lat = restaurants[0].location.data.lat;
                center.lng = restaurants[0].location.data.lng;
            }

            const map = new google.maps.Map(document.getElementById("map"), {
                zoom: 13,
                center: center,
                mapTypeControl: false,
                streetViewControl: false,
                fullscreenControl: false,
                clickableIcons: false // é¿å…é»åˆ° Google åŸæœ¬åœ°æ¨™å¹²æ“¾
            });

            const infoWindow = new google.maps.InfoWindow();

            // 3. æ’’é»è¿´åœˆ
            restaurants.forEach(store => {
                // [ä¿®æ­£é»] é€™è£¡å…¨éƒ¨æ”¹æˆ store.location
                if (!store.location || !store.location.data || !store.location.data.lat) {
                    console.warn("ç•¥éç„¡åº§æ¨™é¤å»³:", store.name);
                    return;
                }

                const position = { 
                    lat: store.location.data.lat, 
                    lng: store.location.data.lng 
                };

                const marker = new google.maps.Marker({
                    position: position, 
                    map: map,
                    title: store.name
                });

                // é»æ“Šäº‹ä»¶ (Info Window)
                marker.addListener("click", () => {
                    // ç°¡å–®çš„å¡ç‰‡æ¨£å¼
                    const content = `
                        <div style="padding:12px; max-width:220px; font-family: sans-serif;">
                            <h3 style="margin:0 0 5px 0; font-size:16px; color:#333;">${store.name}</h3>
                            <p style="margin:0 0 10px 0; color:#888; font-size:12px;">
                                ${store.category || 'ç¾é£Ÿ'}
                            </p>
                            <a href="https://www.google.com/maps/search/?api=1&query=${encodeURIComponent(store.name)}" 
                               target="_blank" 
                               style="display:block; text-align:center; background:#FF6B6B; color:white; text-decoration:none; padding:8px 0; border-radius:6px; font-size:14px; font-weight:bold;">
                               ğŸ“ å°èˆªå»é€™
                            </a>
                        </div>
                    `;
                    infoWindow.setContent(content);
                    infoWindow.open(map, marker);
                });
            });
        }
    </script>
    
    <script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyBxA02Disbhv_kHeJ8OlTF2rCOTmXTqN1E&callback=main" async defer></script>
</body>
</html>
