<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>NomNom ç¾é£Ÿåœ°åœ–</title>
    <style>
        /* åŸºç¤è¨­å®š */
        html, body { height: 100%; margin: 0; padding: 0; font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; }
        
        #map { height: 100%; width: 100%; }
        
        /* è¼‰å…¥ç•«é¢ */
        .loading { 
            position: absolute; top: 50%; left: 50%; 
            transform: translate(-50%, -50%); 
            color: #666; font-size: 14px;
            background: rgba(255,255,255,0.95);
            padding: 20px 30px; border-radius: 12px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
            z-index: 100;
            display: flex; flex-direction: column; align-items: center;
            font-weight: bold;
        }

        /* å®šä½æŒ‰éˆ• (ä»¿ Google Maps åŸç”Ÿæ¨£å¼) */
        #locationButton {
            display: none;
            position: absolute; 
            bottom: 120px; /* é¿é–‹å³ä¸‹è§’çš„ Google Logo */
            right: 16px; 
            z-index: 5;
            background: white;
            border: none;
            border-radius: 50%;
            width: 48px; height: 48px;
            box-shadow: 0 2px 6px rgba(0,0,0,0.3);
            cursor: pointer;
            font-size: 22px;
            display: flex; align-items: center; justify-content: center;
        }
        #locationButton:active { background: #f0f0f0; }
    </style>
</head>
<body>
    <div id="map"></div>
    
    <div id="loading" class="loading">
        <span>ğŸ± æ­£åœ¨è®€å–ç¾é£Ÿæ¸…å–®...</span>
    </div>
    
    <button id="locationButton" title="å›åˆ°æˆ‘çš„ä½ç½®">ğŸ“</button>

    <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>

    <script>
        // ==========================================
        // 1. è¨­å®šæª” (å·²æ›´æ–°)
        // ==========================================
        const CONFIG = {
            LIFF_ID: "2008587350-Nba5PAbR",
            XANO_API: "https://x8ki-letl-twmt.n7.xano.io/api:ygZLF4dX/user/map_restaurants",
            GOOGLE_MAPS_KEY: "AIzaSyBxA02Disbhv_kHeJ8OlTF2rCOTmXTqN1E"
        };

        // é è¨­åœ–ç¤º (ç•¶æ‰¾ä¸åˆ°åˆ†é¡åœ–ç¤ºæ™‚ä½¿ç”¨)
        const DEFAULT_ICON = "https://res.cloudinary.com/dtlxflkkb/image/upload/v1764438323/location-pin_wjwvj6.png";

        // ==========================================
        // 2. ä¸»ç¨‹å¼é‚è¼¯
        // ==========================================
        
        async function main() {
            try {
                // åˆå§‹åŒ– LIFF
                await liff.init({ liffId: CONFIG.LIFF_ID });

                if (!liff.isLoggedIn()) {
                    liff.login();
                    return;
                }

                const profile = await liff.getProfile();
                const userId = profile.userId;
                
                console.log("User ID:", userId);

                // å‘¼å« Xano API (åŠ å…¥ timestamp é¿å…å¿«å–)
                const apiUrl = `${CONFIG.XANO_API}?line_user_id=${userId}&t=${new Date().getTime()}`;
                const response = await fetch(apiUrl);
                
                if (!response.ok) throw new Error("API è«‹æ±‚å¤±æ•—");
                
                const responseData = await response.json();
                
                // --- [é—œéµé‚è¼¯] Side-loading çµ„è£ ---
                
                // 1. å–å‡ºé¤å»³åˆ—è¡¨ (items)
                const restaurants = responseData.items || [];
                
                // 2. å–å‡ºåˆ†é¡åƒç…§è¡¨ (refs) ä¸¦å»ºç«‹æŸ¥æ‰¾è¡¨ (Map)
                const iconMap = {};
                const refs = responseData.refs || [];
                
                refs.forEach(cat => {
                    // å»ºç«‹å°ç…§: "æ‹‰éºµ" -> "https://..."
                    if (cat.name && cat.icon_url) {
                        iconMap[cat.name] = cat.icon_url;
                    }
                });

                console.log("Icon Map å»ºç«‹å®Œæˆ:", iconMap);
                
                // 3. é–‹å§‹ç•«åœ°åœ–
                document.getElementById('loading').style.display = 'none';
                initMap(restaurants, iconMap);

            } catch (error) {
                document.getElementById('loading').innerHTML = `âš ï¸ ç™¼ç”ŸéŒ¯èª¤ï¼š<br>${error.message}`;
                console.error(error);
            }
        }

        function initMap(restaurants, iconMap) {
            console.log(`å…±è¼‰å…¥ ${restaurants.length} é–“é¤å»³`);

            // é è¨­ä¸­å¿ƒé» (å°åŒ—)
            let center = { lat: 25.0478, lng: 121.5170 };
            
            // å¦‚æœæœ‰è³‡æ–™ï¼Œä»¥ç¬¬ä¸€ç­†è³‡æ–™ç‚ºä¸­å¿ƒ
            if (restaurants.length > 0 && restaurants[0].location && restaurants[0].location.data) {
                center = {
                    lat: restaurants[0].location.data.lat,
                    lng: restaurants[0].location.data.lng
                };
            }

            const map = new google.maps.Map(document.getElementById("map"), {
                zoom: 14,
                center: center,
                mapTypeControl: false,
                streetViewControl: false,
                fullscreenControl: false,
                clickableIcons: false,
                // åŠ ä¸Šæ¨£å¼èª¿æ•´ï¼Œè®“åœ°åœ–æ¯”è¼ƒä¹¾æ·¨ (é¸ç”¨)
                styles: [
                    { featureType: "poi", elementType: "labels", stylers: [{ visibility: "off" }] }
                ]
            });

            const infoWindow = new google.maps.InfoWindow();

            // --- æ’’é»è¿´åœˆ ---
            restaurants.forEach(store => {
                // é˜²å‘†ï¼šç¢ºèªæœ‰åº§æ¨™
                if (!store.location || !store.location.data || !store.location.data.lat) return;

                // [é—œéµé‚è¼¯] æ±ºå®šåœ–ç¤º
                // æ‹¿ store.category (æ–‡å­—) å»æŸ¥ iconMap
                const categoryName = store.category || "";
                const iconUrl = iconMap[categoryName] ? iconMap[categoryName] : DEFAULT_ICON;

                const customIcon = {
                    url: iconUrl,
                    scaledSize: new google.maps.Size(48, 48), // è¨­å®šé¡¯ç¤ºå¤§å°
                    origin: new google.maps.Point(0, 0),
                    anchor: new google.maps.Point(24, 24)     // ä¸­å¿ƒé»
                };

                const position = { 
                    lat: store.location.data.lat, 
                    lng: store.location.data.lng 
                };

                const marker = new google.maps.Marker({
                    position: position, 
                    map: map,
                    title: store.name,
                    icon: customIcon // å¥—ç”¨åœ–ç¤º
                });

                // é»æ“Šäº‹ä»¶ (Info Window)
                marker.addListener("click", () => {
                    // é è¨­å°é¢åœ–
                    const bgImage = store.cover_image || 'https://images.unsplash.com/photo-1555396273-367ea4eb4db5?w=400';
                    
                    const content = `
                        <div style="padding:0; max-width:240px; font-family: sans-serif;">
                            <div style="
                                height:120px; width:100%; 
                                background-image:url('${bgImage}'); 
                                background-size:cover; background-position:center; 
                                border-radius:6px 6px 0 0; margin-bottom:10px;">
                            </div>
                            <div style="padding: 0 10px 10px 10px;">
                                <h3 style="margin:0 0 5px 0; font-size:16px; color:#333;">${store.name}</h3>
                                <p style="margin:0 0 10px 0; color:#888; font-size:12px;">
                                    <span style="color:#FF6B6B; font-weight:bold;">${store.category || 'ç¾é£Ÿ'}</span>
                                </p>
                                <a href="https://www.google.com/maps/search/?api=1&query=${encodeURIComponent(store.name)}" 
                                   target="_blank" 
                                   style="
                                     display:block; text-align:center; 
                                     background:#FF6B6B; color:white; 
                                     text-decoration:none; padding:8px 0; 
                                     border-radius:4px; font-size:14px; font-weight:bold; box-shadow: 0 2px 4px rgba(0,0,0,0.2);">
                                   ğŸ“ å°èˆªå»é€™
                                </a>
                            </div>
                        </div>
                    `;
                    infoWindow.setContent(content);
                    infoWindow.open(map, marker);
                });
            });

            // å•Ÿå‹•ä½¿ç”¨è€…å®šä½
            setupMyLocation(map);
        }

        // ä½¿ç”¨è€…å®šä½åŠŸèƒ½ (è—é» + æŒ‰éˆ•)
        function setupMyLocation(map) {
            const locationBtn = document.getElementById("locationButton");
            locationBtn.style.display = "flex";

            const userIcon = {
                path: google.maps.SymbolPath.CIRCLE,
                fillColor: '#4285F4',
                fillOpacity: 1,
                scale: 7,
                strokeColor: 'white',
                strokeWeight: 2,
                strokeOpacity: 1
            };
            
            let userMarker = null;
            let accuracyCircle = null;

            const goToMyLocation = () => {
                if (navigator.geolocation) {
                    navigator.geolocation.getCurrentPosition(
                        (position) => {
                            const pos = {
                                lat: position.coords.latitude,
                                lng: position.coords.longitude,
                            };

                            if (accuracyCircle) accuracyCircle.setMap(null);

                            if (!userMarker) {
                                userMarker = new google.maps.Marker({
                                    position: pos,
                                    map: map,
                                    icon: userIcon,
                                    title: "æ‚¨çš„ä½ç½®",
                                    zIndex: 999
                                });
                            } else {
                                userMarker.setPosition(pos);
                            }

                            accuracyCircle = new google.maps.Circle({
                                strokeColor: "#4285F4",
                                strokeOpacity: 0.2,
                                strokeWeight: 1,
                                fillColor: "#4285F4",
                                fillOpacity: 0.1,
                                map: map,
                                center: pos,
                                radius: position.coords.accuracy || 50
                            });

                            map.setCenter(pos);
                            map.setZoom(15);
                        },
                        (error) => {
                            console.error("å®šä½å¤±æ•—:", error);
                        },
                        { enableHighAccuracy: true }
                    );
                }
            };

            locationBtn.addEventListener("click", goToMyLocation);
            goToMyLocation(); // è¼‰å…¥æ™‚è‡ªå‹•å®šä½
        }
    </script>
    
    <script>
        const script = document.createElement('script');
        script.src = `https://maps.googleapis.com/maps/api/js?key=${CONFIG.GOOGLE_MAPS_KEY}&callback=main`;
        script.async = true;
        script.defer = true;
        document.head.appendChild(script);
    </script>
</body>
</html>
