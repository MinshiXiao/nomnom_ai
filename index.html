<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>NomNom ç¾é£Ÿåœ°åœ–</title>
    <style>
        /* 1. åŸºç¤è¨­å®šï¼šè®“åœ°åœ–å¡«æ»¿æ‰‹æ©Ÿè¢å¹• */
        html, body { height: 100%; margin: 0; padding: 0; font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; }
        
        #map { height: 100%; width: 100%; }
        
        /* 2. è¼‰å…¥ç•«é¢æ¨£å¼ */
        .loading { 
            position: absolute; top: 50%; left: 50%; 
            transform: translate(-50%, -50%); 
            color: #666; font-size: 14px;
            background: rgba(255,255,255,0.9);
            padding: 20px; border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            z-index: 100;
            display: flex; flex-direction: column; align-items: center;
        }

        /* 3. å®šä½æŒ‰éˆ•æ¨£å¼ (ä»¿ Google Maps åŸç”ŸæŒ‰éˆ•) */
        #locationButton {
            display: none; /* åˆå§‹éš±è— */
            position: absolute; 
            bottom: 120px; /* é¿é–‹å³ä¸‹è§’çš„ Google Logo */
            right: 16px; 
            z-index: 5;
            background: white;
            border: none;
            border-radius: 50%; /* åœ“å½¢æŒ‰éˆ• */
            width: 48px; height: 48px;
            box-shadow: 0 2px 6px rgba(0,0,0,0.3);
            cursor: pointer;
            font-size: 22px;
            align-items: center; justify-content: center;
        }
        #locationButton:active { background: #f0f0f0; }
    </style>
</head>
<body>
    <div id="map"></div>
    
    <div id="loading" class="loading">
        <span>ğŸ± æ­£åœ¨è®€å–ç¾é£Ÿæ¸…å–®...</span>
    </div>
    
    <button id="locationButton" title="å›åˆ°æˆ‘çš„ä½ç½®">ğŸ“</button>

    <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>

    <script>
        // ==========================================
        // âš ï¸ è«‹ä¿®æ”¹ä»¥ä¸‹è®Šæ•¸
        // ==========================================
        const CONFIG = {
            LIFF_ID: "2008587350-Nba5PAbR", 
            XANO_API: "https://x8ki-letl-twmt.n7.xano.io/api:ygZLF4dX/user/map_restaurants", 
            GOOGLE_MAPS_KEY: "AIzaSyBxA02Disbhv_kHeJ8OlTF2rCOTmXTqN1E" 
        };

        // ==========================================
        // ä¸»ç¨‹å¼é‚è¼¯
        // ==========================================
        
        async function main() {
            try {
                // 1. åˆå§‹åŒ– LIFF
                await liff.init({ liffId: CONFIG.LIFF_ID });

                // 2. æª¢æŸ¥ç™»å…¥ç‹€æ…‹
                if (!liff.isLoggedIn()) {
                    liff.login();
                    return;
                }

                // 3. å–å¾—ç”¨æˆ¶ ID
                const profile = await liff.getProfile();
                const userId = profile.userId;
                
                console.log("User ID:", userId);

                // 4. å‘¼å« Xano API å–å¾—é¤å»³è³‡æ–™
                // è¨˜å¾—åŠ ä¸Šæ™‚é–“æˆ³è¨˜é¿å…å¿«å– (cache busting)
                const apiUrl = `${CONFIG.XANO_API}?line_user_id=${userId}&t=${new Date().getTime()}`;
                const response = await fetch(apiUrl);
                
                if (!response.ok) throw new Error("API è«‹æ±‚å¤±æ•—");
                
                const data = await response.json();
                
                // 5. éš±è— Loadingï¼Œé–‹å§‹ç•«åœ°åœ–
                document.getElementById('loading').style.display = 'none';
                initMap(data);

            } catch (error) {
                document.getElementById('loading').innerHTML = `âš ï¸ ç™¼ç”ŸéŒ¯èª¤ï¼š<br>${error.message}`;
                console.error(error);
            }
        }

        function initMap(data) {
            // è™•ç† Xano å›å‚³æ ¼å¼ (é™£åˆ—æˆ–ç‰©ä»¶)
            const restaurants = Array.isArray(data) ? data : (data.restaurants || data.items || []);
            console.log(`å…±è¼‰å…¥ ${restaurants.length} é–“é¤å»³`);

            // é è¨­ä¸­å¿ƒé» (å°åŒ—è»Šç«™)
            let center = { lat: 25.0478, lng: 121.5170 };
            
            // å¦‚æœæœ‰è³‡æ–™ï¼Œä»¥ç¬¬ä¸€ç­†è³‡æ–™ç‚ºä¸­å¿ƒ
            if (restaurants.length > 0 && restaurants[0].location && restaurants[0].location.data) {
                center = {
                    lat: restaurants[0].location.data.lat,
                    lng: restaurants[0].location.data.lng
                };
            }

            // åˆå§‹åŒ– Google Map
            const map = new google.maps.Map(document.getElementById("map"), {
                zoom: 14,
                center: center,
                mapTypeControl: false,       // éš±è—åœ°åœ–é¡å‹æ§åˆ¶
                streetViewControl: false,    // éš±è—è¡—æ™¯å°äºº
                fullscreenControl: false,    // éš±è—å…¨è¢å¹•æŒ‰éˆ•
                clickableIcons: false        // é¿å…é»åˆ°åœ°åœ–åŸç”Ÿæ¨™åœ°
            });

            const infoWindow = new google.maps.InfoWindow();

            // æ’’é» (Markers)
            restaurants.forEach(store => {
                // é˜²å‘†æª¢æŸ¥ï¼šç¢ºèªæœ‰åº§æ¨™è³‡æ–™
                if (!store.location || !store.location.data || !store.location.data.lat) return;

                const position = { 
                    lat: store.location.data.lat, 
                    lng: store.location.data.lng 
                };

                const marker = new google.maps.Marker({
                    position: position, 
                    map: map,
                    title: store.name,
                    // å¦‚æœä½ æƒ³è‡ªè¨‚åœ–é‡˜é¡è‰²ï¼Œå¯ä»¥åœ¨é€™è£¡åŠ  icon å±¬æ€§
                });

                // é»æ“Šåœ–é‡˜äº‹ä»¶ (è³‡è¨Šå¡)
                marker.addListener("click", () => {
                    // é è¨­åœ–ç‰‡
                    const bgImage = store.cover_image || 'https://images.unsplash.com/photo-1555396273-367ea4eb4db5?w=400';
                    
                    const content = `
                        <div style="padding:0; max-width:240px; font-family: sans-serif;">
                            <div style="
                                height:120px; width:100%; 
                                background-image:url('${bgImage}'); 
                                background-size:cover; background-position:center; 
                                border-radius:6px 6px 0 0; margin-bottom:10px;">
                            </div>
                            <div style="padding: 0 10px 10px 10px;">
                                <h3 style="margin:0 0 5px 0; font-size:16px; color:#333;">${store.name}</h3>
                                <p style="margin:0 0 10px 0; color:#888; font-size:12px;">
                                    ğŸ·ï¸ ${store.category || 'ç¾é£Ÿ'}
                                </p>
                                <a href="https://www.google.com/maps/search/?api=1&query=${encodeURIComponent(store.name)}" 
                                   target="_blank" 
                                   style="
                                     display:block; text-align:center; 
                                     background:#FF6B6B; color:white; 
                                     text-decoration:none; padding:8px 0; 
                                     border-radius:4px; font-size:14px; font-weight:bold;">
                                   ğŸ“ å°èˆªå»é€™
                                </a>
                            </div>
                        </div>
                    `;
                    infoWindow.setContent(content);
                    infoWindow.open(map, marker);
                });
            });

            // å•Ÿå‹•ä½¿ç”¨è€…å®šä½åŠŸèƒ½
            setupMyLocation(map);
        }

        // ä½¿ç”¨è€…å®šä½é‚è¼¯ (è—é» + æŒ‰éˆ•)
        function setupMyLocation(map) {
            const locationBtn = document.getElementById("locationButton");
            locationBtn.style.display = "flex"; // é¡¯ç¤ºæŒ‰éˆ•

            // å®šç¾©è—è‰²å°åœ“é»æ¨£å¼
            const userIcon = {
                path: google.maps.SymbolPath.CIRCLE,
                fillColor: '#4285F4',
                fillOpacity: 1,
                scale: 7,
                strokeColor: 'white',
                strokeWeight: 2,
                strokeOpacity: 1
            };
            
            // èª¤å·®ç¯„åœåœ“åœˆ
            let accuracyCircle = null;
            let userMarker = null;

            const goToMyLocation = () => {
                if (navigator.geolocation) {
                    navigator.geolocation.getCurrentPosition(
                        (position) => {
                            const pos = {
                                lat: position.coords.latitude,
                                lng: position.coords.longitude,
                            };

                            // æ¸…é™¤èˆŠçš„èª¤å·®åœ“
                            if (accuracyCircle) accuracyCircle.setMap(null);

                            if (!userMarker) {
                                // å»ºç«‹è—é»
                                userMarker = new google.maps.Marker({
                                    position: pos,
                                    map: map,
                                    icon: userIcon,
                                    title: "æ‚¨çš„ä½ç½®",
                                    zIndex: 999
                                });
                            } else {
                                userMarker.setPosition(pos);
                            }

                            // ç•«å‡ºèª¤å·®ç¯„åœ (æ·¡è—è‰²åœ“åœˆ)
                            accuracyCircle = new google.maps.Circle({
                                strokeColor: "#4285F4",
                                strokeOpacity: 0.2,
                                strokeWeight: 1,
                                fillColor: "#4285F4",
                                fillOpacity: 0.1,
                                map: map,
                                center: pos,
                                radius: position.coords.accuracy || 50
                            });

                            map.setCenter(pos);
                            map.setZoom(15);
                        },
                        (error) => {
                            console.error(error);
                            // éœé»˜å¤±æ•—æˆ–ç°¡å–®æç¤ºï¼Œé¿å…ä¸€ç›´è·³çª—
                        },
                        { enableHighAccuracy: true } // è¦æ±‚é«˜ç²¾æº–åº¦
                    );
                } else {
                    alert("ç€è¦½å™¨ä¸æ”¯æ´å®šä½åŠŸèƒ½");
                }
            };

            // ç¶å®šæŒ‰éˆ•äº‹ä»¶
            locationBtn.addEventListener("click", goToMyLocation);

            // ç¶²é è¼‰å…¥æ™‚è‡ªå‹•åŸ·è¡Œä¸€æ¬¡
            goToMyLocation();
        }
    </script>
    
    <script>
        const script = document.createElement('script');
        script.src = `https://maps.googleapis.com/maps/api/js?key=${CONFIG.GOOGLE_MAPS_KEY}&callback=main`;
        script.async = true;
        script.defer = true;
        document.head.appendChild(script);
    </script>
</body>
</html>
