<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>NomNom ç¾é£Ÿåœ°åœ–</title>
    <style>
        /* è®“åœ°åœ–å¡«æ»¿è¢å¹• */
        html, body { height: 100%; margin: 0; padding: 0; }
        #map { height: 100%; width: 100%; }
        .loading { 
            position: absolute; top: 50%; left: 50%; 
            transform: translate(-50%, -50%); 
            font-family: sans-serif; color: #666;
        }
    </style>
</head>
<body>
    <div id="map"></div>
    <div id="loading" class="loading">è®€å–ç¾é£Ÿè³‡æ–™ä¸­...</div>

    <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>

    <script>
        const XANO_API_URL = "https://x8ki-letl-twmt.n7.xano.io/api:ygZLF4dX/user/map_restaurants"; // å¡«å…¥ Xano API

        async function main() {
            // 1. åˆå§‹åŒ– LIFF
            await liff.init({ liffId: "2008587350-Nba5PAbR" }); // å¡«å…¥ LIFF ID

            if (!liff.isLoggedIn()) {
                liff.login();
                return;
            }

            const profile = await liff.getProfile();
            const userId = profile.userId;

            // 2. å‘¼å« Xano æ‹¿è³‡æ–™
            try {
                const response = await fetch(`${XANO_API_URL}?line_user_id=${userId}`);
                const restaurants = await response.json();
                
                document.getElementById('loading').style.display = 'none';
                initMap(restaurants);
            } catch (error) {
                alert("è®€å–è³‡æ–™å¤±æ•—ï¼š" + error.message);
            }
        }

        function initMap(data) {
            // é è¨­ä¸­å¿ƒé» (å°åŒ—)
            const center = { lat: 25.0478, lng: 121.5170 };
            
            // å¦‚æœæœ‰è³‡æ–™ï¼Œä»¥ç¬¬ä¸€ç­†è³‡æ–™ç‚ºä¸­å¿ƒ
            if (data.length > 0 && data[0].geo_point) {
                center.lat = data[0].geo_point.data.lat;
                center.lng = data[0].geo_point.data.lng;
            }

            const map = new google.maps.Map(document.getElementById("map"), {
                zoom: 13,
                center: center,
                mapTypeControl: false,
                streetViewControl: false
            });

            // 3. æ’’é»
            const infoWindow = new google.maps.InfoWindow();

            data.forEach(store => {
                if (!store.geo_point) return;

                const marker = new google.maps.Marker({
                    position: store.geo_point.data, // Xano GeoPoint çµæ§‹
                    map: map,
                    title: store.name
                });

                // é»æ“Šåœ–é‡˜é¡¯ç¤ºè³‡è¨Šèˆ‡å°èˆªæŒ‰éˆ•
                marker.addListener("click", () => {
                    const content = `
                        <div style="padding:5px; max-width:200px;">
                            <h3 style="margin:0 0 5px 0;">${store.name}</h3>
                            <p style="margin:0 0 5px 0; color:#666; font-size:12px;">${store.category || 'ç¾é£Ÿ'}</p>
                            <a href="https://www.google.com/maps/search/?api=1&query=${encodeURIComponent(store.name)}" 
                               target="_blank" 
                               style="display:inline-block; background:#FF6B6B; color:white; text-decoration:none; padding:5px 10px; border-radius:4px; font-size:12px;">
                               ğŸ“ å°èˆª
                            </a>
                        </div>
                    `;
                    infoWindow.setContent(content);
                    infoWindow.open(map, marker);
                });
            });
        }
    </script>
    
    <script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyBxA02Disbhv_kHeJ8OlTF2rCOTmXTqN1E&callback=main" async defer></script>
</body>
</html>
